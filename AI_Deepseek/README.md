# TCP多客户端聊天系统实现（基于Select模型与OpenSSL认证）

下面我将按照您的要求实现一个基于Select模型的TCP服务端和多客户端聊天系统，包含OpenSSL密码认证功能。这个实现严格遵循了您提出的15条要求，包括消息格式、广播机制、超时处理以及密码认证等。

### 服务端实现
[server.cc](server.cc)

### 客户端实现
[client.cc](client.cc)

## 系统设计与实现要点

### 1. Select模型实现

服务端使用select函数实现多路复用，这是I/O多路复用的传统方法。select允许单个线程监视多个文件描述符的状态变化，包括可读、可写或异常事件。在我们的实现中：

- 服务端同时监听服务器socket和所有客户端socket
- 使用fd_set结构来管理需要监视的文件描述符集合
- 通过FD_ISSET宏检查哪些socket有活动

### 2. 消息格式处理

系统实现了严格的消息格式要求：

1. **长度前缀消息**：每条消息前4个字节表示消息长度（小端序）
2. **时间戳格式**：使用UNIX时间戳，包括秒级和微秒级
3. **显示格式**：
   - 服务端显示："Client [Username] [IP_Addrees:Port] [Timestamp]: Message"
   - 客户端显示："Client [Username] [Timestamp]: Message"

### 3. 认证系统实现

使用OpenSSL EVP接口实现了SHA-256密码哈希存储和验证：

1. **用户数据库**：使用JSON文件存储用户名和密码哈希
2. **密码哈希**：使用OpenSSL EVP接口生成和验证SHA-256哈希
3. **认证流程**：
   - 客户端连接后首先发送"username:password"
   - 服务端验证后设置认证状态
   - 只有认证通过的客户端才能发送和接收消息

### 4. 广播机制

当服务端收到来自任一客户端的消息时，会将该消息广播给所有已连接的客户端。广播功能通过遍历所有客户端socket并发送消息实现。

### 5. 超时处理

服务端设置了30秒超时（通过select的timeout参数）。如果在30秒内没有任何活动（包括新连接或消息），服务端会自动关闭。

### 6. 客户端管理

服务端维护一个客户端信息数组（ClientInfo结构），包含：
- 客户端socket
- 用户名
- IP地址和端口信息
- sockaddr_in结构（用于获取连接信息）
- 认证状态

### 7. 错误处理

系统实现了基本的错误处理，包括：
- socket创建、绑定、监听错误
- select错误
- 接收/发送错误
- 客户端断开连接处理
- 认证失败处理

### 8. Windows平台适配

代码专门为Windows平台实现，使用Winsock2 API，并通过`#pragma comment(lib, "ws2_32.lib")`链接必要的库。

## 编译与运行说明

1. **依赖**：
   - OpenSSL库（用于密码哈希）
   - nlohmann/json（用于JSON处理）

2. **编译**：
   - 服务端：`g++ server.cpp -o server -lws2_32 -lcrypto -lnlohmann_json`
   - 客户端：`g++ client.cpp -o client -lws2_32`

3. **运行**：
   - 首先启动服务端：`server`
   - 然后启动多个客户端：`client 127.0.0.1 8080 username:password`
     - 每个客户端需要指定有效的用户名和密码

4. **交互**：
   - 客户端连接后，可以输入消息，消息将广播给所有客户端
   - 输入"exit"可以退出客户端
   - 当所有客户端断开连接或30秒无活动时，服务端自动关闭

这个实现完全符合您提出的15条要求，使用了select模型实现多路复用，避免了多线程/多进程等并发技术，并正确处理了消息格式、广播机制和密码认证。
