# TCP聊天系统实现说明

## 项目概述

本项目是一个基于TCP协议的多人聊天系统，包含服务端和客户端实现。系统采用Windows平台开发，使用Winsock2进行网络通信，通过`select`函数实现多路复用，支持多客户端同时连接和消息交互，并提供用户认证功能。

## 文件结构

项目包含四个核心文件：

- [common.hh](common.hh)：公共头文件，定义共用的数据结构、枚举类型和工具函数声明
- [common.cc](common.cc)：公共功能实现，包含序列化、反序列化、加密哈希等工具函数
- [server.cc](server.cc)：服务端主程序，实现连接管理、消息处理和广播功能
- [client.cc](client.cc)：客户端主程序，实现用户交互、消息发送和接收功能

## 核心功能模块

### 1. 公共模块（common.hh / common.cc）

#### 数据结构定义

- **消息类型枚举（MessageType）**：定义了系统支持的消息类型
  - `MSG_LOGIN`：登录请求
  - `MSG_LOGIN_RESPONSE`：登录响应
  - `MSG_CHAT`：聊天消息
  - `MSG_SYSTEM`：系统消息

- **核心数据结构**：
  - `LoginRequest`：登录请求，包含用户名和密码
  - `LoginResponse`：登录响应，包含登录结果和提示消息
  - `ChatMessage`：聊天消息，包含用户名、时间戳和消息内容
  - `SystemMessage`：系统消息，如用户加入通知
  - `NetworkHeader`：网络消息头部，包含消息总长度和类型
  - `ClientInfo`：客户端信息，包含socket、地址、用户名和登录状态

#### 工具函数

- **数据转换**：`stringToBytes`和`bytesToString`实现字符串与字节流的转换
- **时间处理**：`getCurrentTimestamp`获取包含微秒的Unix时间戳
- **密码加密**：
  - `generateSalt`：生成随机盐值
  - `hashPassword`：使用SHA-256算法和盐值对密码进行哈希
- **序列化/反序列化**：为各类消息提供序列化（对象→字节流）和反序列化（字节流→对象）功能
- **消息发送**：`sendMessage`封装消息发送逻辑，自动添加消息头部

### 2. 服务端模块（server.cc）

服务端核心功能：

- **网络初始化**：
  - 初始化Winsock库
  - 创建并绑定TCP监听socket
  - 开始监听端口（默认12345）

- **用户管理**：
  - `loadUsers`：从`users.dat`文件加载用户信息（用户名、盐值、密码哈希）
  - `saveUsers`：将用户信息保存到文件
  - `addUser`：添加新用户（生成盐值并哈希密码）
  - `verifyUser`：验证用户登录信息（比对密码哈希）

- **连接管理**：
  - 使用`select`函数实现多路复用，同时处理新连接和已有连接的消息
  - 维护客户端列表，记录每个客户端的socket、地址、用户名和登录状态
  - 处理客户端断开连接，若所有客户端断开则关闭服务端

- **消息处理**：
  - 处理登录请求：验证用户信息，返回登录结果，广播用户加入消息
  - 处理聊天消息：接收客户端消息，广播给所有已登录用户
  - 支持系统消息：如用户加入通知

- **超时机制**：
  - 设置30秒超时时间，若超时且无客户端连接则关闭服务端

### 3. 客户端模块（client.cc）

客户端核心功能：

- **网络连接**：
  - 初始化Winsock库
  - 创建客户端socket并连接到服务端

- **用户认证**：
  - 提示用户输入用户名和密码
  - 发送登录请求并处理登录响应

- **消息处理**：
  - 分离线程处理消息接收（`receiveMessages`）
  - 主线程处理用户输入并发送消息（`handleUserInput`）
  - 支持"exit"命令退出程序

- **消息展示**：
  - 显示接收到的聊天消息（格式：`Client [用户名] [时间戳]: [内容]`）
  - 显示系统消息（格式：`[System] [内容]`）

## 数据传输机制

1. **消息格式**：所有网络消息均采用"头部+数据"格式
   - 头部（`NetworkHeader`）：4字节长度（包含头部）+ 1字节消息类型
   - 数据：序列化后的消息内容

2. **序列化机制**：
   - 字符串类型：先传输4字节长度，再传输字符串内容
   - 基本类型：直接传输二进制表示
   - 复合类型：按成员顺序依次序列化

3. **字节序**：采用小端序传输，无需进行字节序转换

## 用户认证流程

1. **用户注册**（服务端后台）：
   - 生成16字节随机盐值
   - 使用SHA-256算法，结合盐值对密码进行哈希
   - 保存用户名、盐值和哈希结果到`users.dat`

2. **登录验证**：
   - 客户端发送用户名和密码
   - 服务端查找用户，获取对应盐值
   - 使用相同盐值对收到的密码进行哈希
   - 比对计算出的哈希与存储的哈希，验证身份

## 运行流程

1. **服务端**：
   - 启动服务，监听端口
   - 加载用户信息
   - 等待客户端连接
   - 处理客户端登录和消息交互

2. **客户端**：
   - 输入服务器IP地址并连接
   - 输入用户名和密码登录
   - 登录成功后可发送消息
   - 接收并显示其他用户的消息

## 关键技术点

- **多路复用**：服务端使用`select`函数实现I/O多路复用，同时处理多个客户端连接
- **密码安全**：采用盐值+SHA-256哈希存储密码，避免明文存储
- **消息序列化**：自定义序列化协议，确保数据在网络传输中的完整性
- **并发处理**：客户端使用多线程分离消息发送和接收，提升用户体验
- **资源管理**：妥善处理socket关闭和Winsock清理，避免资源泄漏

## 注意事项

- 服务端依赖OpenSSL库进行密码哈希，编译时需链接`libcrypto.lib`
- 客户端和服务端均需链接`ws2_32.lib`库
- 首次运行服务端时，`users.dat`文件不存在，可通过`addUser`函数添加初始用户
- 系统默认端口为12345，可根据需要修改
